version: 2.1
jobs:
  build:
    machine:
      image: circleci/classic:201808-01
    steps:
      - checkout
      - run:
          command: >-
            curl -L https://golang.org/dl/go1.14.6.linux-amd64.tar.gz | tar xzf - &&
            sudo mv go/bin/go /usr/local/bin/ &&
            sudo mv go/bin/gofmt /usr/local/bin/ && 
            go version
          name: Install recent go

      - run:
          command: >-
            curl -Lo minikube https://github.com/kubernetes/minikube/releases/download/v1.12.1/minikube-linux-amd64 &&
              chmod +x minikube &&
              sudo mv minikube /usr/local/bin/
          name: Install minikube

      - run:
          command: >-
            curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.18.3/bin/linux/amd64/kubectl &&
              chmod +x kubectl &&
              sudo mv kubectl /usr/local/bin/ &&
              mkdir -p ${HOME}/.kube && touch ${HOME}/.kube/config
          name: Install kubectl

      - run:
          command: >-
            sudo -E minikube start --vm-driver=none --kubernetes-version=v1.17.9
          name: Start minikube

      - run: SDK_VERSION=0.18.2 make install-sdk
      - run: make install-tools
      - run: TEST_GROUP=smoke ./.ci/run-e2e-tests.sh
